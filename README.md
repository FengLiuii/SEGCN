The core code of segcn
